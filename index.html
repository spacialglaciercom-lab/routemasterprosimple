<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>RouteMaster PRO - OSM Route Generator (Offline)</title>

<!-- Inlined Tailwind subset (only utilities used in this UI) -->
<style>
  :root{
    --bg:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#0ea5e9;--panel:#ffffff;
    --shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);
    --border:#e5e7eb;--accent:#e0f2fe;--accent-border:#0284c7;
    --success:#10b981;--warn:#f59e0b;--error:#ef4444;--idle:#94a3b8;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif}
  #map{height:100vh;width:100%;z-index:1}
  .hidden{display:none!important}
  #overlay-initial,#overlay-loading{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:999;
  }
  #overlay-initial{background:rgba(255,255,255,.95)}
  #overlay-loading{background:rgba(0,0,0,.8);color:#fff;z-index:1000}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow)}
  .p-4{padding:1rem}.p-8{padding:2rem}.mb-2{margin-bottom:.5rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}
  .max-w-md{max-width:28rem}.text-center{text-align:center}.text-sm{font-size:.875rem}.text-lg{font-size:1.125rem}
  .text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.font-bold{font-weight:700}
  .text-gray-600{color:#475569}.text-blue-600{color:#2563eb}
  .border-2{border-width:2px}.border-dashed{border-style:dashed}.border-gray-300{border-color:#cbd5e1}
  .rounded-lg{border-radius:.75rem}.shadow-lg{box-shadow:var(--shadow)}
  .cursor-pointer{cursor:pointer}.hover\:border-blue-500:hover{border-color:#3b82f6}
  .transition{transition:all .2s ease}
  .flex{display:flex}.gap-2{gap:.5rem}.gap-4{gap:1rem}.items-center{align-items:center}
  .bg-white{background:#fff}.bg-blue-600{background:#2563eb}.bg-gray-600{background:#475569}
  .text-white{color:#fff}.rounded{border-radius:.5rem}
  .hover\:bg-blue-700:hover{background:#1d4ed8}.hover\:bg-gray-700:hover{background:#334155}
  .text-\[10px\]{font-size:10px}.uppercase{text-transform:uppercase}.ml-2{margin-left:.5rem}
  .relative{position:relative}.inline-flex{display:inline-flex}.rounded-full{border-radius:9999px}.h-3{height:.75rem}.w-3{width:.75rem}
  .bg-slate-400{background:#94a3b8}
  #floating-actions{position:fixed;right:20px;bottom:20px;z-index:100}
  #dropZone{border:2px dashed #cbd5e1;border-radius:10px;padding:2rem;text-align:center;cursor:pointer;transition:border-color .2s ease}
  #dropZone.dragover{background:var(--accent);border-color:var(--accent-border)}
</style>

<!-- Leaflet CSS (1.9.4) inlined below by the PowerShell script -->
<style id="leaflet-css">
/* [INLINE_LEAFLET_CSS] */
</style>

<!-- Inline Leaflet marker icons as data URIs so no external images are needed -->
<style>
  .leaflet-container .leaflet-marker-icon,
  .leaflet-container .leaflet-marker-shadow { image-rendering:auto; }
  .leaflet-default-icon { 
    background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAtCAYAAACh8p0TAAA...truncated"); /* marker-icon.png base64 */
    width:25px;height:41px;display:block;
  }
  .leaflet-default-icon-2x { 
    background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAABMCAYAAAB...truncated"); /* marker-icon-2x.png base64 */
    width:50px;height:82px;display:block;
  }
  .leaflet-default-shadow {
    background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACq...truncated"); /* marker-shadow.png base64 */
    width:41px;height:41px;display:block;
  }
</style>
</head>
<body>
  <div id="map"></div>

  <div id="overlay-initial">
    <div class="text-center p-8 bg-white rounded-lg shadow-xl max-w-md panel">
      <h1 class="text-3xl font-bold mb-4">RouteMaster PRO</h1>
      <p class="mb-6 text-gray-600">Upload an OSM XML file to generate an optimized route</p>
      <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 transition" role="button" tabindex="0" aria-label="Drop OSM file here or browse">
        <p class="text-lg mb-2">üìÅ Drag & Drop OSM File Here</p>
        <p class="text-sm text-gray-600">or</p>
        <input type="file" id="fileInput" accept=".osm,.xml" class="mt-4" style="display:none">
        <label for="fileInput" class="block mt-2 text-blue-600 cursor-pointer">Browse Files</label>
      </div>
    </div>
  </div>

  <div id="overlay-loading" class="hidden" aria-live="polite">
    <div class="text-center">
      <h2 id="loading-title" class="text-2xl font-bold mb-2">Processing...</h2>
      <p id="loading-subtitle" class="text-lg">Please wait</p>
    </div>
  </div>

  <div id="floating-actions" class="hidden">
    <div class="bg-white rounded-lg shadow-lg p-4 panel">
      <div class="flex items-center gap-4 mb-4">
        <div>
          <span id="status-dot" class="relative inline-flex rounded-full h-3 w-3 bg-slate-400"></span>
          <span id="status-text" class="text-[10px] font-bold text-slate-600 uppercase ml-2">Idle</span>
        </div>
        <div class="text-sm">
          <span id="stat-ways">0 Ways</span> | <span id="stat-dist">0.00 km</span>
        </div>
      </div>
      <div class="flex gap-2">
        <button id="btnDownload" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Download GPX</button>
        <button id="btnReset" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Reset</button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS (1.9.4) inlined below by the PowerShell script -->
  <script id="leaflet-js">
/* [INLINE_LEAFLET_JS] */
  </script>

  <!-- App logic -->
  <script>
  (function(){
    'use strict';

    // Initialize Leaflet map
    let map, routeLayer;
    function initMap(){
      map = L.map('map', { zoomControl:true, preferCanvas:true }).setView([0,0], 2);

      // OSM tiles (requires internet; swap to local tiles if you need full offline)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // Default icon (ensures no external image fetch)
      const DefaultIcon = L.Icon.extend({
        options: {
          iconUrl: '', iconRetinaUrl: '', shadowUrl: '',
          iconSize: [25,41], iconAnchor:[12,41], popupAnchor:[1,-34], tooltipAnchor:[16,-28], shadowSize:[41,41]
        }
      });
      L.Marker.prototype.options.icon = new DefaultIcon();

      routeLayer = L.layerGroup().addTo(map);
    }

    // UI helpers
    function setStatus(text, colorClass='bg-slate-400'){
      const dot = document.getElementById('status-dot');
      const t = document.getElementById('status-text');
      if (dot) dot.className = `relative inline-flex rounded-full h-3 w-3 ${colorClass}`;
      if (t) t.textContent = text;
    }
    function setStats(ways, km){
      const w = document.getElementById('stat-ways');
      const d = document.getElementById('stat-dist');
      if (w) w.textContent = `${ways} Ways`;
      if (d) d.textContent = `${km.toFixed(2)} km`;
    }
    function showInitialOverlay(show){
      const el = document.getElementById('overlay-initial');
      if (!el) return; el.classList.toggle('hidden', !show);
    }
    function showLoading(show, title='Processing...', subtitle='Please wait'){
      const el = document.getElementById('overlay-loading');
      if (!el) return;
      document.getElementById('loading-title').textContent = title;
      document.getElementById('loading-subtitle').textContent = subtitle;
      el.classList.toggle('hidden', !show);
    }
    function showActions(show){
      const el = document.getElementById('floating-actions');
      if (!el) return; el.classList.toggle('hidden', !show);
    }
    function haversine(a, b){
      const R=6371000;
      const dLat=(b.lat-a.lat)*Math.PI/180;
      const dLon=(b.lng-a.lng)*Math.PI/180;
      const la1=a.lat*Math.PI/180, la2=b.lat*Math.PI/180;
      const s=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(s));
    }

    // Ignore driveways/parking
    function shouldIgnoreWay(tags){
      if (!tags) return false;
      const hwy=tags.highway, service=tags.service, amenity=tags.amenity, parking=tags.parking, access=tags.access, area=tags.area;
      if (amenity==='parking') return true;
      if (parking) return true;
      if ((area==='yes'||area==='true') && amenity==='parking') return true;
      if (hwy==='service'){
        if (service==='driveway' || service==='parking_aisle' || service==='parking') return true;
        if (access==='private') return true;
      }
      if (service==='driveway' || service==='parking_aisle') return true;
      return false;
    }

    // Parse and render OSM XML text
    function parseAndRenderOSM(xmlText){
      const parser = new DOMParser();
      const xml = parser.parseFromString(xmlText, 'application/xml');
      if (xml.getElementsByTagName('parsererror').length){
        throw new Error('OSM XML parse error');
      }

      const nodes = new Map(); // id -> LatLng
      const nodeEls = xml.getElementsByTagName('node');
      for (let i=0;i<nodeEls.length;i++){
        const n=nodeEls[i];
        const id=n.getAttribute('id');
        const lat=parseFloat(n.getAttribute('lat'));
        const lon=parseFloat(n.getAttribute('lon'));
        if (!id || Number.isNaN(lat) || Number.isNaN(lon)) continue;
        nodes.set(id, L.latLng(lat, lon));
      }

      const wayEls = xml.getElementsByTagName('way');
      let waysCount=0, totalMeters=0;
      routeLayer.clearLayers();
      const bounds = L.latLngBounds();

      for (let w=0; w<wayEls.length; w++){
        const way = wayEls[w];

        // Tags
        const tags = {};
        const tagEls = way.getElementsByTagName('tag');
        for (let t=0; t<tagEls.length; t++){
          const k = tagEls[t].getAttribute('k');
          const v = tagEls[t].getAttribute('v');
          if (k) tags[k] = v;
        }

        if (!tags.highway) continue;
        if (shouldIgnoreWay(tags)) continue;

        // Geometry
        const latlngs = [];
        const ndEls = way.getElementsByTagName('nd');
        for (let n=0; n<ndEls.length; n++){
          const ref = ndEls[n].getAttribute('ref');
          const ll = ref ? nodes.get(ref) : undefined;
          if (ll) latlngs.push(ll);
        }
        if (latlngs.length < 2) continue;

        // Length
        let length=0;
        for (let i=1;i<latlngs.length;i++){
          length += haversine(latlngs[i-1], latlngs[i]);
        }
        totalMeters += length;

        // Render
        const line = L.polyline(latlngs, { color: '#0ea5e9', weight: 3, opacity: 0.95 });
        line.addTo(routeLayer);
        bounds.extend(line.getBounds());
        waysCount++;
      }

      if (waysCount > 0){
        map.fitBounds(bounds, { padding:[20,20] });
      }

      setStats(waysCount, totalMeters/1000);
      setStatus(waysCount ? 'Ready':'No ways', waysCount ? 'bg-emerald-500':'bg-amber-500');
      showActions(true);
      showInitialOverlay(false);
    }

    // File handling and wiring
    function handleFile(file){
      setStatus('Loading...', 'bg-blue-500');
      showLoading(true, 'Reading file...', 'Parsing OSM XML');
      const reader = new FileReader();
      reader.onerror = () => {
        showLoading(false); setStatus('Read error','bg-rose-500'); alert('Failed to read file.');
      };
      reader.onload = () => {
        try{
          parseAndRenderOSM(String(reader.result));
          showLoading(false);
        }catch(err){
          console.error(err);
          showLoading(false);
          setStatus('Parse error','bg-rose-500');
          alert('Failed to parse OSM file. See console for details.');
        }
      };
      reader.readAsText(file);
    }
    function wireDrop(){
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      if (fileInput){
        fileInput.addEventListener('change', (e)=>{
          const f=e.target.files && e.target.files[0];
          if (f) handleFile(f);
        });
      }
      if (dropZone){
        const prevent = (ev)=>{ ev.preventDefault(); ev.stopPropagation(); };
        ['dragenter','dragover','dragleave','drop'].forEach(evt=>dropZone.addEventListener(evt,prevent,false));
        dropZone.addEventListener('dragenter',()=>dropZone.classList.add('dragover'));
        dropZone.addEventListener('dragover',()=>dropZone.classList.add('dragover'));
        dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop',(e)=>{
          dropZone.classList.remove('dragover');
          const files = e.dataTransfer && e.dataTransfer.files;
          if (files && files.length) handleFile(files[0]);
        });
        dropZone.addEventListener('click',()=>fileInput && fileInput.click());
        dropZone.addEventListener('keydown',(e)=>{
          if (e.key==='Enter' || e.key===' '){ e.preventDefault(); fileInput && fileInput.click(); }
        });
      }
      document.getElementById('btnDownload').addEventListener('click', downloadGPX);
      document.getElementById('btnReset').addEventListener('click', resetApp);
    }

    function downloadGPX(){
      const lines = [];
      routeLayer.eachLayer((l)=>{ if (l instanceof L.Polyline) lines.push(l); });
      if (!lines.length){ alert('No route to export.'); return; }
      let gpx = `<?xml version="1.0" encoding="UTF-8"?>\n`;
      gpx += `<gpx version="1.1" creator="RouteMaster PRO" xmlns="http://www.topografix.com/GPX/1/1">\n`;
      gpx += `  <trk>\n    <name>RouteMaster Export</name>\n`;
      for (const line of lines){
        const latlngs = line.getLatLngs();
        gpx += `    <trkseg>\n`;
        for (const ll of latlngs){
          gpx += `      <trkpt lat="${ll.lat}" lon="${ll.lng}"></trkpt>\n`;
        }
        gpx += `    </trkseg>\n`;
      }
      gpx += `  </trk>\n</gpx>\n`;
      const blob = new Blob([gpx], {type:'application/gpx+xml'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'route.gpx';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function resetApp(){
      routeLayer.clearLayers();
      setStats(0,0);
      setStatus('Idle','bg-slate-400');
      showActions(false);
      showInitialOverlay(true);
      map.setView([0,0], 2);
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      initMap();
      wireDrop();
      setStatus('Idle','bg-slate-400');
      setStats(0,0);
      showActions(false);
    });
  })();
  </script>
</body>
</html>
